<html ng-app="pogolyticsApp">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>pogolytics</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
				integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

	<!-- font awesome -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css"
				integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
					integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
					crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
					integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
					crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
					integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
					crossorigin="anonymous"></script>

	<!-- angular js -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-sanitize.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.js"></script>
	<script src="js/angular-filter.min.js"></script>
	<script src="js/inputDropdown.js"></script>

	<!-- local styles and scripts -->
	<link rel="stylesheet" href="css/inputDropdownStyles.css">
	<link rel="stylesheet" href="css/style.css">
	<script>

    (function () {

      const pogolyticsApp = angular.module('pogolyticsApp', ['ngSanitize', 'angular.filter', 'inputDropdown']);
      pogolyticsApp.directive("ngBindHtmlCompile", function ($compile, $sce) {
        return {
          restrict: "A",
          link: function (scope, element, attrs) {
            scope.$watch(attrs.ngBindHtmlCompile, function (html) {
              let el = angular.element("<span>").html(html);
              element.empty();
              element.append(el);
              $compile(element.contents())(scope);
            })
          }
        };
      });
      pogolyticsApp.directive('tooltip', function () {
        return {
          restrict: 'A',
          link: function (scope, element, attrs) {
            element.tooltip();
          }
        };
      });

      pogolyticsApp.controller('pogolyticsCtrl', function ($scope, $http, $q) {
        $http.get('pogo.json')
        .then(function (r) {
          var _ = $scope._ = r.data;
          _.pokemonNamesList = [];
					for(let name in $scope._.pokemons){
            _.pokemonNamesList.push(name);
					}
        });


        $scope.cp = function (p, ivs, cpm) {
          return Math.floor(0.1 * (p.atk+ivs[0]) * ((p.def+ivs[1])**0.5) * ((p.sta+ivs[2])**0.5) * cpm*cpm);
        };

        $scope.iv2pct = function (ivSet) {
          return Math.round(100 * (ivSet[0] + ivSet[1] + ivSet[2]) / 45);
        };

        $scope.getLevels = function () {
          let levels = [];
          for (let i = 2; i <= 80; i++) {
						levels.push(1.0*i/2);
          }
          return levels;
        }

        $scope.filterStringList = function(userInput) {
          var filter = $q.defer();
          var normalisedInput = userInput.toLowerCase();

          var filteredArray = $scope._.pokemonNamesList.filter(function(str) {
            return str.toLowerCase().indexOf(normalisedInput) !== -1;
          });

          filter.resolve(filteredArray);
          return filter.promise;
        };

        $scope.nums = function (num) {
          return Array.apply(null, Array(num)).map(function (_, i) {return i;});
        };
				$scope.cnt = 4;
				$scope.model = {levels:[15.0,20.0,25,40,35,30]};
      });


      pogolyticsApp.filter('urlEncode', function () {
        return window.encodeURIComponent;
      });
      pogolyticsApp.filter('spaceToDash',function() {
        return function(input) {
          if (input) {
            return input.replace(/\s+/g, '-');
          }
        }
      });
    })();
	</script>
</head>
<body>
<div ng-controller="pogolyticsCtrl" class="pogolytics container">
	<h4>pogolytics</h4>
	<h3>IV to CP chart</h3>
	<hr/>
	<div class="input-group">
		<div class="input-group-prepend">
			<span class="input-group-text" id="inputGroupPrepend">Pok√©mon</span>
		</div>
		<select class="form-control" id="Pokemon" ng-model="model.mon" >
			<option ng-repeat="(name, pokemon) in _.pokemons" value="{{name}}">
				{{name}}
			</option>
		</select>
		<input-dropdown
				class="input-group-append"
				selected-item="model.mon"
				default-dropdown-items="_.pokemonNamesList"
				filter-list-method="filterStringList(userInput)"
				input-class-name="form-control rounded-0"
				input-placeholder="type name">
		</input-dropdown>
	</div>
	<hr/>
	<input class="form-control" type="number" ng-model="cnt" />
	<table class="table table-striped">
		<thead>
			<tr>
				<th rowspan="2">Stats</th>
				<th rowspan="2">IV %</th>
				<th rowspan="1" colspan="{{cnt}}">
					Level
				</th>
			</tr>
			<tr>
				<th ng-repeat="i in nums(cnt) track by $index">
					<input type="number" step="0.5" min="1" max="40" class="form-control" ng-model="model.levels[i]">
				</th>
			</tr>
		</thead>
		<tbody>
			<tr ng-repeat="iv in _.ivSets" ng-if="model.mon">
				<td class="stats">{{iv[0]}}/{{iv[1]}}/{{iv[2]}}</td>
				<td class="stats">{{iv2pct(iv)}}</td>
				<td class="cp" ng-repeat="i in nums(cnt) track by $index"
						ng-bind-html-compile='cp(_.pokemons[model.mon],iv,_.CPM[model.levels[i]])'> </td>
			</tr>
		</tbody>
	</table>

</div>
<script>
	$(function () {
    console.log('Doc Init');
    $('[data-toggle="tooltip"]').tooltip()
	})
</script>
</body>
</html>
